schemaVersion: '2.0'
builds:
- name: base-docker-3.0.19
  branchName: cie-cassandra-3.0.19
  build:
    template: dockerfile:v1:publish
    buildFilePath: rio/
  trigger:
    gitPush: false
  publish:
    docker:
      namespace: pie
      registry: docker.apple.com
      tag: latest
  timeout: 30
- name: ghprb-3.0.19
  branchName: cie-cassandra-3.0.19
  jenkins:
    concurrentBuild: true
    maxConcurrentTotal: 8
  build:
    template: freestyle:v2:prb
    steps:
    - ./rio/test.sh
  machine:
    docker:
      baseImage: docker.apple.com/pie/cie_cassandra:latest
  publish:
    reports:
      junit: true
  timeout: 60
- name: build-3.0.19
  branchName: cie-cassandra-3.0.19
  build:
    template: freestyle:v2:build
    steps:
    - ./rio/test.sh
  machine:
    docker:
      baseImage: docker.apple.com/pie/cie_cassandra:latest
  publish:
    reports:
      junit: true
  timeout: 60
  finally:
    pipelineChain:
        - pipeline: snapshot-3.0.19
- name: snapshot-3.0.19
  branchName: cie-cassandra-3.0.19
  build:
    template: freestyle:v2:snapshot
    steps:
        - ./rio/release.sh 3.0.19-SNAPSHOT
  machine:
    docker:
      baseImage: docker.apple.com/cpbuild/jdk1.8:latest
  publish:
    archives:
      includePattern: ".dist/publishable/**"
    reports:
      junit: false
  finally:
    tag:
      enabled: false
    pipelineChain:
        - pipeline: snapshot-carnival-3.0.19
  trigger:
    gitPush: false
- name: snapshot-carnival-3.0.19
  branchName: cie-cassandra-3.0.19
  build:
    template: freestyle:v2:carnival
    steps:
    - ./rio/carnival.sh 3.0.19
  machine:
    docker:
      baseImage: docker.apple.com/cpbuild/jdk1.8:latest
  publish:
    reports:
      junit: false
    carnival:
      packageName: CIEDb
      packageSuffix: three-zero-nineteen-snapshot
      packagePath: CIEDb/Updates/
    releaseTrain: 1BUILD
  trigger:
    gitPush: false
  finally:
    tag:
      expression: cie-cassandra-3.0.19-$RIO_BUILD_NUMBER.$CODE_VERSION
    radar:
      annotate: true
- name: release-3.0.19
  branchName: cie-cassandra-3.0.19
  build:
    template: freestyle:v2:release
    steps:
    - ./rio/release.sh 3.0.19.000
  machine:
    docker:
      baseImage: docker.apple.com/cpbuild/jdk1.8:latest
  publish:
    archives:
      includePattern: ".dist/publishable/**"
    reports:
      junit: false
  finally:
    tag:
      enabled: false
    pipelineChain:
      - pipeline: carnival-3.0.19
  trigger:
    gitPush: false
- name: carnival-3.0.19
  branchName: cie-cassandra-3.0.19
  build:
    template: freestyle:v2:carnival
    steps:
    - ./rio/carnival.sh 3.0.19.000
  machine:
    docker:
      baseImage: docker.apple.com/cpbuild/jdk1.8:latest
  publish:
    reports:
      junit: false
    carnival:
      packageName: CIEDb
      packageSuffix: three-zero-nineteen-zerozerozero
      packagePath: CIEDb/Updates/
    releaseTrain: 1BUILD
  finally:
    tag:
      expression: cie-cassandra-3.0.19.000
    radar:
      annotate: true
    pipelineChain:
      - pipeline: release-3.0.19-docker-image
  trigger:
    gitPush: false

- name: release-3.0.19-docker-image
  branchName: cie-cassandra-3.0.19
  machine:
    baseImage: docker.apple.com/cpbuild/jdk1.8:latest
    env:
      CASSANDRA_VERSION: "3.0.19.000"
  build:
    template: freestyle:v4:publish
    steps:
      - ./rio/release.sh ${CASSANDRA_VERSION}
  trigger:
    gitPush: false
  package:
    dockerfile:
      - dockerfilePath: "Dockerfile"
        extraTags:
          - ${CASSANDRA_VERSION}
        publish:
          - repo: docker.apple.com/piedb/cie-cassandra
        perApplication: false


- name: dtest-3.0.19
  branchName: cie-cassandra-3.0.19
  build:
    template: freestyle:v2:build
    steps:
    - /home/tests/run_int.sh --with-xunit --xunit-file=/code/nosetests.xml --test-select-config=conf/cie-cassandra-3.0-all.cfg
  machine:
    docker:
      baseImage: docker.apple.com/pie/cie_cassandra_dtest
  publish:
    logs: logs/
    reports:
      junit:
        path: nosetests.xml
  timeout: 600
  trigger:
    gitPush: true
- name: dtest-3.0.19-fast
  branchName: cie-cassandra-3.0.19
  build:
    template: freestyle:v2:build
    steps:
    - /home/tests/run_int.sh --with-xunit --xunit-file=/code/nosetests.xml --test-select-config=conf/cie-cassandra-3.0-fastest.cfg
  machine:
    env:
      DTEST_TIMEOUT: 300
    docker:
      baseImage: docker.apple.com/pie/cie_cassandra_dtest
  publish:
    logs: logs/
    reports:
      junit:
        path: nosetests.xml
  timeout: 480
  trigger:
    gitPush: true
- name: ghprb-dtest-3.0.19
  disabled: true
  branchName: cie-cassandra-3.0.19
  build:
    template: freestyle:v2:prb
    steps:
    - /home/tests/run_int.sh --with-xunit --xunit-file=/code/nosetests.xml --test-select-config=conf/cie-cassandra-3.0-all.cfg
  machine:
    docker:
      baseImage: docker.apple.com/pie/cie_cassandra_dtest
  publish:
    logs: logs/
    reports:
      junit:
        path: nosetests.xml
  timeout: 600

