schemaVersion: '2.0'
builds:
- name: base-docker-3.0.19
  branchName: cie-cassandra-3.0.19
  timeout: 30
  build:
    template: freestyle:v4:publish
    steps:
      - echo 'Running build'
  trigger:
    gitPush: false
  machine:
    baseImage: docker.apple.com/pie/fuji
    env:
      RELEASE_VERSION: "3.0.19"
      PACKAGE_VERSION: "${RELEASE_VERSION}-build.#{${RELEASE_VERSION}}"
  package:
    release: true
    slug: false
    libraries: false
    dockerfile:
      - dockerfilePath: "rio/images/cassandra/Dockerfile-jdk8"
        version: "${PACKAGE_VERSION}"
        perApplication: false
        extraTags:
          - latest
        publish:
          - repo: docker.apple.com/pie/cie-cassandra-build-jdk-8

- name: ghprb-3.0.19
  branchName: cie-cassandra-3.0.19
  jenkins:
    concurrentBuild: true
    maxConcurrentTotal: 8
  build:
    template: freestyle:v4:prb
    steps:
    - ./rio/parallel-tests.sh ./rio/unittests.yml parallel-output
    - mkdir -p .out/test-results
    - cp build/test/output/*.xml .out/test-results/
  machine:
    baseImage: docker.apple.com/piedb/parallelci:latest
  secrets:
    names:
      - k8s_auth_token
      - k8s_auth_token.us-west-1a
      - mcqueen.yml
  reports:
    junit: true
    logs:
      paths:
        - parallel-output/**/test/logs/*.log
        - parallel-output/**/.command/*/*
  timeout: 180
- name: build-3.0.19
  branchName: cie-cassandra-3.0.19
  build:
    template: freestyle:v4:build
    steps:
    - ./rio/parallel-tests.sh ./rio/unittests.yml parallel-output
    - mkdir -p .out/test-results
    - cp build/test/output/*.xml .out/test-results/
  machine:
    baseImage: docker.apple.com/piedb/parallelci:latest
  secrets:
    names:
      - k8s_auth_token
      - k8s_auth_token.us-west-1a
      - mcqueen.yml
  reports:
    junit: true
    logs:
      paths:
        - parallel-output/**/test/logs/*.log
        - parallel-output/**/.command/*/*
  timeout: 180
  finally:
    pipelineChain:
        - pipeline: snapshot-3.0.19
- name: snapshot-3.0.19
  branchName: cie-cassandra-3.0.19
  build:
    template: freestyle:v2:snapshot
    steps:
        - ./rio/release.sh 3.0.19-SNAPSHOT
  machine:
    docker:
      baseImage: docker.apple.com/pie/cie-cassandra-build-jdk-8:latest
  publish:
    archives:
      includePattern: ".dist/publishable/**"
    reports:
      junit: false
  finally:
    tag:
      enabled: false
    pipelineChain:
        - pipeline: snapshot-carnival-3.0.19
        - pipeline: snapshot-docker-image-3.0.19
  trigger:
    gitPush: false
- name: snapshot-carnival-3.0.19
  branchName: cie-cassandra-3.0.19
  build:
    template: freestyle:v2:carnival
    steps:
    - ./rio/carnival.sh 3.0.19
  machine:
    docker:
      baseImage: docker.apple.com/pie/cie-cassandra-build-jdk-8:latest
  publish:
    reports:
      junit: false
    carnival:
      packageName: CIEDb
      packageSuffix: three-zero-nineteen-snapshot
      packagePath: CIEDb/Updates/
    releaseTrain: 1BUILD
  trigger:
    gitPush: false
  finally:
    tag:
      expression: cie-cassandra-3.0.19-$RIO_BUILD_NUMBER.$CODE_VERSION
    radar:
      annotate: true
- name: snapshot-docker-image-3.0.19
  branchName: cie-cassandra-3.0.19
  timeout: 30
  machine:
    baseImage: docker.apple.com/pie/cie-cassandra-build-jdk-8:latest
    env:
      RELEASE_VERSION: "3.0.19"
      CASSANDRA_VERSION: "${RELEASE_VERSION}-next.#{${RELEASE_VERSION}-next}"
  build:
    template: freestyle:v4:publish
    steps:
      - ./rio/release.sh ${CASSANDRA_VERSION}
  trigger:
    gitPush: false
  package:
    dockerfile:
      - dockerfilePath: "Dockerfile"
        version: "${CASSANDRA_VERSION}"
        perApplication: false
        extraTags:
          - "${RELEASE_VERSION}-next"
        publish:
          - repo: docker.apple.com/piedb_ci/cie-cassandra
    mirror:
      target: silkroad
- name: release-3.0.19
  branchName: cie-cassandra-3.0.19
  build:
    template: freestyle:v2:release
    steps:
    - ./rio/release.sh 3.0.19.0
  machine:
    docker:
      baseImage: docker.apple.com/pie/cie-cassandra-build-jdk-8:latest
  publish:
    archives:
      includePattern: ".dist/publishable/**"
    reports:
      junit: false
  finally:
    tag:
      enabled: false
    pipelineChain:
      - pipeline: carnival-3.0.19
  trigger:
    gitPush: false
- name: carnival-3.0.19
  branchName: cie-cassandra-3.0.19
  build:
    template: freestyle:v2:carnival
    steps:
    - ./rio/carnival.sh 3.0.19.0
  machine:
    docker:
      baseImage: docker.apple.com/pie/cie-cassandra-build-jdk-8:latest
  publish:
    reports:
      junit: false
    carnival:
      packageName: CIEDb
      packageSuffix: three-zero-nineteen-zero
      packagePath: CIEDb/Updates/
    releaseTrain: 1BUILD
  finally:
    tag:
      expression: cie-cassandra-3.0.19.0
    radar:
      annotate: true
    pipelineChain:
      - pipeline: release-3.0.19-docker-image
  trigger:
    gitPush: false

- name: release-3.0.19-docker-image
  branchName: cie-cassandra-3.0.19
  machine:
    baseImage: docker.apple.com/pie/cie-cassandra-build-jdk-8:latest
    env:
      CASSANDRA_VERSION: "3.0.19.0"
  build:
    template: freestyle:v4:publish
    steps:
      - ./rio/release.sh ${CASSANDRA_VERSION}
  trigger:
    gitPush: false
  package:
    dockerfile:
      - dockerfilePath: "Dockerfile"
        extraTags:
          - ${CASSANDRA_VERSION}
        publish:
          - repo: docker.apple.com/piedb/cie-cassandra
        perApplication: false
    mirror:
      target: silkroad
